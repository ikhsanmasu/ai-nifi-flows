version: '3.8'

services:
  nifi:
    image: apache/nifi:2.6.0
    container_name: nifi
    hostname: nifi
    
    ports:
      - "18443:18443"
    
    environment:
      SINGLE_USER_CREDENTIALS_USERNAME: admin
      SINGLE_USER_CREDENTIALS_PASSWORD: ${NIFI_PASSWORD:-adminadmin123}
      
      NIFI_WEB_HTTPS_PORT: 18443
      NIFI_WEB_HTTPS_HOST: 0.0.0.0
      NIFI_WEB_PROXY_HOST: localhost:18443
      
      NIFI_JVM_HEAP_INIT: 2g
      NIFI_JVM_HEAP_MAX: 4g
    
    volumes:
      - ./nifi-jdbc-drivers:/opt/nifi/nifi-current/lib/jdbc:ro
      - nifi_conf:/opt/nifi/nifi-current/conf
      - nifi_content_repository:/opt/nifi/nifi-current/content_repository
      - nifi_database_repository:/opt/nifi/nifi-current/database_repository
      - nifi_flowfile_repository:/opt/nifi/nifi-current/flowfile_repository
      - nifi_provenance_repository:/opt/nifi/nifi-current/provenance_repository
      - nifi_state:/opt/nifi/nifi-current/state
      - nifi_logs:/opt/nifi/nifi-current/logs
    
    networks:
      - nifi_network
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD-SHELL", "netstat -tln | grep -q ':18443' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s

volumes:
  nifi_conf:
  nifi_content_repository:
  nifi_database_repository:
  nifi_flowfile_repository:
  nifi_provenance_repository:
  nifi_state:
  nifi_logs:

networks:
  nifi_network:
    driver: bridge
